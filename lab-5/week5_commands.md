# Commands for Week 5

See full Week 5 instructions on [Protocals.io](https://www.protocols.io/private/bba6f8f98e03c9de92641ca3810b212c)



## Getting Started

> This week in lab we’re going to learn how to make phylogenetic trees. We’ll start by creating a multiple sequence alignment with MUSCLE, and then we will make bootstrapped maximum likelihood phylogenetic trees with RAxML. We’ll use the Newick files generated by RAxML to visualize trees in an online tree visualization tool called the Interactive Tree of Life (iToL). We’ll do this using toy datasets, and then try out some trees on your project datsets.

### Get into liverpool

```bash
ssh michelsd@liverpool.its.carleton.edu`
```

### Copy data to the class shared site

**!! STILL NEED TO DO !!**

```bash
cp ERR599031_ORFs.faa /usr/local/data/class_shared/
cp ERR598983_interproscan_results.txt /usr/local/data/class_shared/
```



## A. Aligning Sequences

### Get new toy data

Copy the toy dataset from the data directory to new toy dataset directory

```bash
mkdir alignments_and_trees
cd alignments_and_trees/
cp /usr/local/data/toy_datasets/toy_dataset_PSII_protein.faa .
```

###  Make a multiple sequence alignment using muscle

```bash
muscle -in toy_dataset_PSII_protein.faa -out toy_dataset_PSII_protein_aligned.afa
```

> *What this means:* muscle is the name of the program
>
> * `–in` defines the name of your input file, which can be either DNA or protein
> * `-out` defines the name of your output file. I like to give them an easy-to-recognize name with the extension “.afa”, which stands for “aligned fasta file.”

### Look at alignment with Seaview

To secure copy file the file:

- Open a new terminal window and don't log into liverpool
- Navigate to the right folder

```bash
scp michelsd@liverpool.its.carleton.edu:/Accounts/michelsd/toy_dataset_directory/alignments_and_trees/toy_dataset_PSII_protein_aligned.afa .
```

Open with application called "Seaview" by dragging file onto window.

> Seaview shows the names of the sequences to the left. The letters to the right are the amino acids in your sequence, color-coded to make the alignment easier to see. You can easily see that some regions of the sequence are more highly conserved than others, and that some species appear to have an insertion or deletion in specific regions of the sequence. Note that this is an **amino acid** alignment, not a nucleotide alignment. (You could easily use muscle to align in nucleotides as well.)





## B. Creating phylogenetic trees with RAxML

Use Rika's python script to convert from  aligned fasta (.afa) file into Phylip file (.phy)

```bash
convert_afa_to_phy.py toy_dataset_PSII_protein_aligned.afa
```

> The top of a Phylip file indicates the number of sequences (in this case, 17) and the number of base pairs in the aligned sequences (571). It’s followed by the first 54 bases of each sequence, broken up by a space every 10 letters. Every new line shows a new sequence (from a different species or organism). The next 54 letters of each sequence starts after the first set, and continues like this for the rest of the file. (Yes, it’s weird, but a lot of tree-building programs use this format.)



Make a tree with raxml

```
raxmlHPC-PTHREADS-AVX -f a -# 20 -m PROTGAMMAAUTO -p 12345 -x 12345 -s toy_dataset_PSII_protein_aligned.phy -n toy_dataset_PSII_protein.tree -T 4
```

> What this means:
>
> * `raxmlHPC-PTHREADS-AVX` is the name of the software package. This one is configured for the processors that are specific to this server.
> * `-f a` allows for rapid bootstrapping. This means RAxML will do a maximum likelihood search based on your protein sequences, and then bootstrap it as many times as you wish.
> * `-# 20` tells the program to bootstrap 20 times.
> * `-m PROTGAMMAAUTO` tells the program that these are protein sequences, and tells the program how to model protein evolution. To get into this is beyond the scope of this class, but fortunately RAxML is able to automatically choose the best one for us based on the number of sequences and the type of data we have.
> * `-p` and `–x` provide seed numbers so that the program can generate random numbers for the bootstrapping process.
> * `-s` gives the name of your input Phylip file
> * `-n` gives the name of your output Newick file, which will be made into a tree.
> * `-T` determines the number of threads. This is sort of like determining how many processors you'll use up for this process. Today, we'll use 4. Please don't use more than this without asking first.





## Asking biological questions with trees

*<u>Question</u>*: "What evolutionary clade do photosynthesis genes from surface waters fall into?"

### Finding gene of interest

1. First, we need to identify a target protein within the photosynthetic apparatus.

   * See:  [KEGG Pathways website](http://www.genome.jp/kegg/pathway.html)

   * > Click on 'Energy' under 'Metabolism' and then click on 'Photosynthesis.' You should see a depiction of the photosynthetic proteins. Let's choose a protein within the photosynthetic apparatus that might be of interest. For the sake of this example, let's choose psbA: it's part of the photosystem II p680 reaction center D protein. Click on the box labeled 'PsbA' beneath the figure. Now you'll see lots of information about that particular gene. You can use the KEGG website like this to figure out which proteins or genes might be of interest for your projects later on.

2. To get seed sequences, use PFAM ([link to psbA](http://pfam.xfam.org/family/PF00124)) 

   * > Click on '988' sequences near the top click on 'FASTA' from the dropdown menu, click 'No gaps (unaligned)' from the drop-down menu, and save the resulting file on liverpool



### Blast seed of gene against database of ORFs from Tara Oceans

```bash
# find matches to that gene in our dataset
# We're going to use ORFs from a Tara Oceans dataset from the North Atlantic surface oceans off the East Coast
cp /usr/local/data/toy_datasets/ERR598983_ORFs.faa .

# Make this dataset into a BLAST database
makeblastdb -in ERR598983_ORFs.faa -dbtype prot

# BLAST it
blastp -query PF00124_seed.txt -db ERR598983_ORFs.faa -outfmt 6 -evalue 1e-05 -out PF00124_vs_ERR598983_ORFs.blastp

# Take a look at the results. You'll notice lots of hits. However, you'll see that all of the hits were to a single ORF: contig-100_83_1. 
less PF00124_vs_ERR598983_ORFs.blastp
```



### Make Tree

> Now let's add it to the original Pfam file and make a tree from all of those sequences. First, make a copy of the original Pfam file and give it a new name. Then use nano to open it up and paste the ORF sequence to the bottom.

```bash
cp PF00124seed.txt PF00124seed_plus_new_ORF.fasta
nano PF00124_seed_plus_new_ORF.fasta
```



```bash
# Make a copy og original Pfam file
cp PF00124seed.txt PF00124seed_plus_new_ORF.fasta

# Open with Vim and add particular ORF sequence to bottom
# [ vi, G, $, a, cmd+v ]

# Make a multiple sequence alignment with muscle.
muscle -in PF00124_seed_plus_new_ORF.fasta -out PF00124_seed_plus_new_ORF_aligned.afa

# Convert your aligned FASTA file to a Phylip file.
convert_afa_to_phy.py PF00124_seed_plus_new_ORF_aligned.afa

# Make tree
raxmlHPC-PTHREADS-AVX -f a -# 20 -m PROTGAMMAAUTO -p 12345 -x 12345 -s PF00124_seed_plus_new_ORF_aligned.phy -n PF00124_seed_plus_new_ORF.tree -T 4
```



---

## Asking my own question

Download 16s seed from PFAM

```bash
# Rearrange files...
# (on server)
cd project_directory
mkdir alignments_and_trees
cp mapping/ERR599031_ORFs.noasterisks.faa alignments_and_trees/
mv ERR599031_ORFs.noasterisks.faa ERR599031_ORFs.faa

# Make db
# (on server)
makeblastdb -in ERR599031_ORFs.faa -dbtype prot

# blast
# (on server)
blastp -query 16s_protein_fasta.txt -db ERR599031_ORFs.faa -outfmt 6 -evalue 1e-08 -out 16s_protein_vs_ERR599031_ORFs.blastp

# extract protein sequences for matching contigs, using python script
# (on my comptuer)
python3 blastp_to_fasta.py

# Make a multiple sequence alignment with muscle
# (on server)
muscle -in 16s_ORF_project.fasta -out 16s_ORF_project.afa

# Covert afa to phy
# (on server)
convert_afa_to_phy.py 16s_ORF_project.afa

# Make tree, take 1
# (on server --> failed	)
raxmlHPC-PTHREADS-AVX -f a -# 20 -m PROTGAMMAAUTO -p 12345 -x 12345 -s 16s_ORF_project.phy -n 16s_ORF_project.tree -T 4

# Make tree, take 2
# (on my computer)
./raxml  -f a -# 20 -m PROTGAMMAAUTO -p 12345 -x 12345 -s 16s_ORF_project.phy -n 16s_ORF_project.tree -T 4


```